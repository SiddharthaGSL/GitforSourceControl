procedure "main"."p2_psite_posbillvoid_bulk_ins(bigint, text)" {
  text = """

DECLARE

   c1rec CURSOR FOR
      SELECT lpcardno, lppointsearned
        FROM staging2_posbillvoid
       WHERE lppointbenefitdetailid IS NOT NULL;
BEGIN
   INSERT INTO psite_posbillvoid(code,
                                  admsite_code,
                                  voidbillno,
                                  voidbilldate,
                                  psite_possession_code,
                                  terminal,
                                  psite_customer_code,
                                  customer,
                                  psite_stockpoint_code,
                                  remarks,
                                  noofprints,
                                  mpsite_discount_code,
                                  mdiscountdesc,
                                  mdiscountprocess,
                                  mrpamt,
                                  basicamt,
                                  promoamt,
                                  saleamt,
                                  returnamt,
                                  grossamt,
                                  idiscountamt,
                                  mdiscountamt,
                                  discountamt,
                                  netamt,
                                  chargeamt,
                                  roundoff,
                                  netpayable,
                                  promocode,
                                  promono,
                                  promoname,
                                  promostartdate,
                                  promoenddate,
                                  promostarttime,
                                  promoendtime,
                                  promoadvtmedia,
                                  promoslabrangefrom,
                                  promoslabrangeto,
                                  promobenefit,
                                  promocleared,
                                  lpcardno,
                                  lpdiscountamt,
                                  lppointsearned,
                                  lpbenefit_discount_code,
                                  lpcard_benefit_discount_code,
                                  lpdiscountbenefit,
                                  lpbenefit_point_code,
                                  lpcard_benefit_point_code,
                                  lppointbenefit,
                                  extaxamt,
                                  createdon,
                                  createby,
                                  voidon,
                                  voidby,
                                  udfstring1,
                                  udfstring2,
                                  udfstring3,
                                  udfstring4,
                                  udfstring5,
                                  voidreason,
                                  voidremarks,
                                  posmode,
                                  roundbasis,
                                  roundmultiples,
                                  roundlimit,
                                  tpcrmcustomername,
                                  tpcrmcustomermobile,
                                  tpcrmrefnumber,
                                  tpcrmredtype,
                                  tpcrmredfactor,
                                  tpcrmdiscvalidationcode,
                                  tpcrmcoupontype,
                                  tpcrmcouponcode,
                                  couponoffer_code,
                                  udfstring6,
                                  udfstring7,
                                  udfstring8,
                                  udfstring9,
                                  udfstring10,
                                  customerpanno,
                                  guid,
                                  udfnum01,
                                  udfnum02,
                                  udfnum03,
                                  udfnum04,
                                  udfnum05,
                                  udfdate01,
                                  udfdate02,
                                  udfdate03,
                                  udfdate04,
                                  udfdate05,
                                  fintradegrp_code,
                                  owner_gstin_no,
                                  owner_gstin_state_code,
                                  cp_gstin_no,
                                  cp_gstin_state_code,
                                  gstdocno,
                                  gstdocseq,
                                  emr_red_point_ref,
                                  emr_red_coupon_ref,
                                  emr_bill_submit_ref,
                                  emr_billvoid_submit_ref,
                                  allow_point_accrual,
                                  TPLoyaltyProvider,
                                  EMRSubmitStatus,
                                  EMRVoidSubmitStatus)
      SELECT concat(p_sitecuid,'-',posbillvoidid)/*p_sitecuid || '-' || posbillvoidid*/,
             p_admsite_code,
             voidbillno,
             voidbilldate,
             concat(p_sitecuid,'-',possessionid)/*p_sitecuid || '-' || possessionid*/,
             concat(terminalname,terminalinitial)/*terminalname || terminalinitial*/,
             coalesce(m.new_psite_customer_code, s.customerid) customerid,
             customername,
             concat(p_sitecuid,'-',stockpointid)/*p_sitecuid || '-' || stockpointid*/,
             remarks,
             noofprints,
             mdiscountid,
             mdiscountdesc,
             mdiscountprocess,
             mrpamt,
             basicamt,
             promoamt,
             saleamt,
             returnamt,
             grossamt,
             idiscountamt,
             mdiscountamt,
             discountamt,
             netamt,
             chargeamt,
             roundoff,
             netpayable,
             promocode,
             promono,
             promoname,
             promostartdate,
             promoenddate,
             promostarttime,
             promoendtime,
             promoadvtmedia,
             promoslabrangefrom,
             promoslabrangeto,
             promobenefit,
             promocleared,
             lpcardno,
             lpdiscountamt,
             lppointsearned,
             lpdiscountbenefitid,
             lpdiscountbenefitdetailid,
             lpdiscountbenefit,
             lppointbenefitid,
             lppointbenefitdetailid,
             lppointbenefit,
             extaxamt,
             s.createdon,
             s.createdby,
             voidon,
             voidby,
             udfstring1,
             udfstring2,
             udfstring3,
             udfstring4,
             udfstring5,
             voidreason,
             voidremarks,
             posmode,
             roundbasis,
             roundmultiples,
             roundlimit,
             tpcrmcustomername,
             tpcrmcustomermobile,
             tpcrmrefnumber,
             tpcrmredtype,
             tpcrmredfactor,
             tpcrmdiscvalidationcode,
             tpcrmcoupontype,
             tpcrmcouponcode,
             couponofferid,
             udfstring6,
             udfstring7,
             udfstring8,
             udfstring9,
             udfstring10,
             customerpanno,
             guid,
             udfnum01,
             udfnum02,
             udfnum03,
             udfnum04,
             udfnum05,
             udfdate01,
             udfdate02,
             udfdate03,
             udfdate04,
             udfdate05,
             tradegroupid,
             ownergstinno,
             ownergstinstatecode,
             cpgstinno,
             cpgststatecode,
             gstdocno,
             gstdocseq,
             emrredpointref,
             emrredcouponref,
             emrbillsubmitref,
             emrbillvoidsubmitref,
             allowpointaccrual,
             TPLoyaltyProvider,
             EMRSubmitStatus,
             EMRVoidSubmitStatus
        FROM staging2_posbillvoid s
LEFT OUTER JOIN psite_customer_merge m ON (s.customerid = m.old_psite_customer_code);
   FOR c1 IN c1rec
   LOOP
      UPDATE lpcard_point
         SET earned = coalesce(earned, 0) - coalesce(c1.lppointsearned, 0),
             closing =
                  coalesce(opening, 0)
                + coalesce(earned, 0)
                - coalesce(c1.lppointsearned, 0)
                - coalesce(redeemed, 0)
       WHERE cardno = c1.lpcardno;
   END LOOP;
END;
"""
  arguments = <
    {
      name = p_admsite_code
      type = bigint
      mode = IN
    }

    {
      name = p_sitecuid
      type = text
      mode = IN
    }

  >
  language = plpgsql
}

